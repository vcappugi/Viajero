{% extends 'base.html' %}
{% block title %}{{ title }} - VIAJERO{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto mt-8 px-4 pb-20">
    <div class="mb-6 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <a href="{% url 'viaticos:solicitud_list' %}" class="btn btn-ghost btn-circle shadow-sm">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="text-3xl font-black text-primary">{{ title }}</h1>
        </div>
    </div>

    <form method="post" class="space-y-8" id="solicitudForm">
        {% csrf_token %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna Principal: Datos Maestros -->
            <div class="lg:col-span-2 space-y-6">
                <div class="card bg-base-100 shadow-xl border border-base-200">
                    <div class="card-body">
                        <h2 class="card-title text-primary"><i class="fas fa-file-invoice mr-2"></i>Cabecera de
                            Solicitud</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-4">
                            <div class="form-control col-span-1 md:col-span-2">
                                <label class="label"><span
                                        class="label-text font-bold text-base-content">{{form.solicitante.label }}*

                                    </span></label>
                                {{ form.solicitante }}
                            </div>
                            <div class="form-control col-span-1 md:col-span-2 lg:col-span-1">
                                <label class="label"><span class="label-text font-bold text-base-content">{{form.empresa.label }}*</span></label>
                                {{ form.empresa }}
                            </div>
                            <div class="form-control">
                                <label class="label"><span class="label-text font-bold text-base-content">{{form.fecha_solicitud.label }}*</span></label>
                                {{ form.fecha_solicitud }}
                            </div>
                            <div class="form-control">
                                <label class="label"><span class="label-text font-bold text-base-content">{{form.cantidad_personas.label }}*</span></label>
                                {{ form.cantidad_personas }}
                            </div>
                            <div class="form-control col-span-1 md:col-span-2 lg:col-span-1">
                                <label class="label"><span class="label-text font-bold text-base-content">{{form.estado_solicitud.label }}*</span></label>
                                {{ form.estado_solicitud }}
                            </div>
                            <div class="form-control">
                                <label class="label"><span class="label-text font-bold text-base-content">{{form.desde.label }}*</span></label>
                                {{ form.desde }}
                            </div>
                            <div class="form-control">
                                <label class="label"><span class="label-text font-bold text-base-content">{{form.hasta.label }}*</span></label>
                                {{ form.hasta }}
                            </div>
                            <div class="form-control col-span-1 md:col-span-2 lg:col-span-1">
                                <label class="label"><span class="label-text font-bold text-base-content">{{form.localidad.label }}*</span></label>
                                {{ form.localidad }}
                            </div>
                            <div class="form-control col-span-1 md:col-span-2 lg:col-span-1">
                                <label class="label"><span class="label-text font-bold text-base-content">{{form.descripcion.label }}*</span></label>
                                {{ form.descripcion }}
                            </div>
                           
                        </div>
                    </div>
                </div>

                <!-- Detalle de la Solicitud -->
                <div class="card bg-base-100 shadow-xl border border-base-200">
                    <div class="card-body">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="card-title text-primary"><i class="fas fa-list-ul mr-2"></i>Conceptos de Gastos
                            </h2>
                            <button type="button" id="add-item" class="btn btn-secondary btn-sm">
                                <i class="fas fa-plus mr-2"></i>Agregar Concepto
                            </button>
                        </div>

                        {{ formset.management_form }}
                        <div class="overflow-x-auto">
                            <table class="table w-full" id="detallesTable">
                                <thead class="bg-base-200">
                                    <tr>
                                        <th>Gasto / Concepto</th>
                                        <th class="w-32">Cantidad</th>
                                        <th class="w-20">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="formset-container">
                                    {% for detail_form in formset %}
                                    <tr class="formset-row" data-form-index="{{ forloop.counter0 }}">
                                        {% for hidden in detail_form.hidden_fields %}
                                        {{ hidden }}
                                        {% endfor %}
                                        <td>
                                            {{ detail_form.tipo_viatico }}
                                            {% if detail_form.tipo_viatico.errors %}
                                            <p class="text-error text-[10px] mt-1">{{ detail_form.tipo_viatico.errors.0
                                                }}</p>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ detail_form.cantidad }}
                                            {% if detail_form.cantidad.errors %}
                                            <p class="text-error text-[10px] mt-1">{{ detail_form.cantidad.errors.0 }}
                                            </p>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if formset.can_delete %}
                                            {{ detail_form.DELETE }}
                                            <button type="button" class="btn btn-error btn-sm btn-circle remove-row-btn" title="Eliminar línea">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Plantilla para nuevas filas -->
                        <template id="empty-form-template">
                            <tr class="formset-row">
                                {% with detail_form=formset.empty_form %}
                                {% for hidden in detail_form.hidden_fields %}
                                {{ hidden }}
                                {% endfor %}
                                <td>
                                    {{ detail_form.tipo_viatico }}
                                </td>
                                <td>
                                    {{ detail_form.cantidad }}
                                </td>
                                <td class="text-center">
                                    {% if formset.can_delete %}
                                    {{ detail_form.DELETE }}
                                    <button type="button" class="btn btn-error btn-sm btn-circle remove-row-btn" title="Eliminar línea">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    {% endif %}
                                </td>
                                {% endwith %}
                            </tr>
                        </template>

                        <p class="text-xs opacity-50 italic mt-4">Nota: Los montos se calculan automáticamente al
                            guardar según el tipo de viático y la tasa de cambio vigente.</p>
                    </div>
                </div>
            </div>

            <!-- Columna Lateral: Resumen y Acciones -->
            <div class="space-y-6">
                {% if solicitud %}
                <div class="card bg-primary text-primary-content shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title text-sm opacity-80 uppercase tracking-widest">Resumen Actual</h2>
                        <div class="mt-4 space-y-4">
                            <div>
                                <div class="text-2xl font-black">${{ solicitud.total_dolares }}</div>
                                <div class="text-[10px] opacity-70">TOTAL ESTIMADO USD</div>
                            </div>
                            <div class="border-t border-primary-content/20 pt-4">
                                <div class="text-xl font-bold">{{ solicitud.total_bolivares|default:"0.00" }} Bs.</div>
                                <div class="text-[10px] opacity-70">TOTAL ESTIMADO BS.</div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="card bg-base-100 shadow-xl border border-base-200">
                    <div class="card-body">
                        <h2 class="card-title text-primary"><i class="fas fa-save mr-2"></i>Acciones</h2>
                        <div class="flex flex-col gap-3 mt-4">
                            <button type="submit" class="btn btn-primary shadow-lg"><i
                                    class="fas fa-check-circle mr-2"></i>Guardar Solicitud</button>
                            <a href="{% url 'viaticos:solicitud_list' %}" class="btn btn-ghost">Cancelar</a>
                        </div>
                    </div>
                </div>

                <!-- Ayuda contextual -->
                <div class="alert alert-info shadow-sm py-3">
                    <i class="fas fa-info-circle"></i>
                    <div class="text-xs">
                        Una vez guardada, la solicitud será visible para el <b>aprobador administrativo</b> asignado en
                        su perfil.
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const cantPersonasInput = document.querySelector('input[name="cantidad_personas"]');
        const container = document.getElementById('formset-container');
        const addButton = document.getElementById('add-item');
        const totalFormsInput = document.getElementById('id_detalles-TOTAL_FORMS');
        const emptyFormTemplate = document.getElementById('empty-form-template');

        // Función para actualizar sugerencias de cantidad
        function updateCantidades() {
            const val = cantPersonasInput.value;
            const detalleCantInputs = document.querySelectorAll('.formset-row input[name$="-cantidad"]');
            detalleCantInputs.forEach(input => {
                if (!input.value || input.value == '1' || input.value == '0') {
                    input.value = val;
                }
            });
        }

        if (cantPersonasInput) {
            cantPersonasInput.addEventListener('change', updateCantidades);
        }

        // Lógica para agregar nuevas filas
        if (addButton && container && totalFormsInput && emptyFormTemplate) {
            addButton.addEventListener('click', function () {
                const currentCount = parseInt(totalFormsInput.value);
                const templateHtml = emptyFormTemplate.innerHTML;

                // Reemplazar el prefijo __prefix__ por el índice actual
                const newRowHtml = templateHtml.replace(/__prefix__/g, currentCount);

                // Crear un elemento temporal para insertar el HTML
                const tempTable = document.createElement('table');
                tempTable.innerHTML = `<tbody>${newRowHtml}</tbody>`;
                const newRow = tempTable.querySelector('tr');

                // Agregar atributo data-form-index
                newRow.setAttribute('data-form-index', currentCount);

                // Agregar la nueva fila al contenedor
                container.appendChild(newRow);

                // Incrementar el contador de formularios
                totalFormsInput.value = currentCount + 1;

                // Sugerir cantidad si corresponde
                updateCantidades();

                // Agregar event listener al nuevo botón de eliminar
                const newRemoveBtn = newRow.querySelector('.remove-row-btn');
                if (newRemoveBtn) {
                    newRemoveBtn.addEventListener('click', handleRemoveRow);
                }
            });
        }

        // Función para manejar la eliminación de filas
        function handleRemoveRow(event) {
            const button = event.currentTarget;
            const row = button.closest('tr.formset-row');
            const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
            
            if (deleteCheckbox) {
                // Marcar el checkbox como eliminado
                deleteCheckbox.checked = true;
                // Ocultar la fila visualmente
                row.style.display = 'none';
            } else {
                // Si no hay checkbox (nueva fila sin guardar), eliminar directamente
                row.remove();
                // Actualizar el contador de formularios
                const currentCount = parseInt(totalFormsInput.value);
                totalFormsInput.value = Math.max(0, currentCount - 1);
            }
        }

        // Agregar event listeners a todos los botones de eliminar existentes
        document.querySelectorAll('.remove-row-btn').forEach(btn => {
            btn.addEventListener('click', handleRemoveRow);
        });

        // Ocultar checkboxes DELETE (solo se usan para el backend)
        document.querySelectorAll('input[type="checkbox"][name$="-DELETE"]').forEach(checkbox => {
            checkbox.style.display = 'none';
        });
    });
</script>
{% endblock %}